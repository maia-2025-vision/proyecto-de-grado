stages:
  patches-512-ol-160-mv01-train:
    cmd: python oficial_herdnet/tools/patcher.py data/train 512 512 160 
      data/patches-512-ol-160-m01/train 
      -csv data/groundtruth/csv/train_big_size_A_B_E_K_WH_WB-fixed-header.csv 
      && python oficial_herdnet/tools/csv_to_points.py 
      -i data/patches-512-ol-160-m01/train/gt.csv 
      -o data/patches-512-ol-160-m01/train_points_gt.csv
    deps:
      - data/groundtruth/csv/train_big_size_A_B_E_K_WH_WB-fixed-header.csv
      - data/train/
      - oficial_herdnet/tools/patcher.py
    outs:
      - data/patches-512-ol-160-m01/train_points_gt.csv
      - data/patches-512-ol-160-m01/train/

  patches-512-ol-160-mv01-val:
    cmd: python oficial_herdnet/tools/patcher.py data/val 512 512 160 
      data/patches-512-ol-160-m01/val 
      -csv data/groundtruth/csv/val_big_size_A_B_E_K_WH_WB-fixed-header.csv 
      && python oficial_herdnet/tools/csv_to_points.py 
      -i data/patches-512-ol-160-m01/val/gt.csv 
      -o data/patches-512-ol-160-m01/val_points_gt.csv
    deps:
      - data/groundtruth/csv/val_big_size_A_B_E_K_WH_WB-fixed-header.csv
      - data/val/
      - oficial_herdnet/tools/patcher.py
    outs:
      - data/patches-512-ol-160-m01/val_points_gt.csv
      - data/patches-512-ol-160-m01/val/

  patches-512-ol-160-mv01-test:
    cmd: python oficial_herdnet/tools/patcher.py data/test 512 512 160 
      data/patches-512-ol-160-m01/test 
      -csv data/groundtruth/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv 
      && python oficial_herdnet/tools/csv_to_points.py 
      -i data/patches-512-ol-160-m01/test/gt.csv 
      -o data/patches-512-ol-160-m01/test_points_gt.csv
    deps:
      - data/groundtruth/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv
      - data/test/
      - oficial_herdnet/tools/patcher.py
    outs:
      - data/patches-512-ol-160-m01/test_points_gt.csv
      - data/patches-512-ol-160-m01/test/

  patches-1024-ol-320-mv01-train:
    cmd: python oficial_herdnet/tools/patcher.py data/train 1024 1024 320 
      data/patches-1024-ol-320-m01/train 
      -csv data/groundtruth/csv/train_big_size_A_B_E_K_WH_WB-fixed-header.csv 
      && python oficial_herdnet/tools/csv_to_points.py 
      -i data/patches-1024-ol-320-m01/train/gt.csv 
      -o data/patches-1024-ol-320-m01/train_points_gt.csv
    deps:
      - data/groundtruth/csv/train_big_size_A_B_E_K_WH_WB-fixed-header.csv
      - data/train/
      - oficial_herdnet/tools/patcher.py
    outs:
      - data/patches-1024-ol-320-m01/train_points_gt.csv
      - data/patches-1024-ol-320-m01/train/

  patches-1024-ol-320-mv01-val:
    cmd: python oficial_herdnet/tools/patcher.py data/val 1024 1024 320 
      data/patches-1024-ol-320-m01/val 
      -csv data/groundtruth/csv/val_big_size_A_B_E_K_WH_WB-fixed-header.csv 
      && python oficial_herdnet/tools/csv_to_points.py 
      -i data/patches-1024-ol-320-m01/val/gt.csv 
      -o data/patches-1024-ol-320-m01/val_points_gt.csv
    deps:
      - data/groundtruth/csv/val_big_size_A_B_E_K_WH_WB-fixed-header.csv
      - data/val/
      - oficial_herdnet/tools/patcher.py
    outs:
      - data/patches-1024-ol-320-m01/val_points_gt.csv
      - data/patches-1024-ol-320-m01/val/

  patches-1024-ol-320-mv01-test:
    cmd: python oficial_herdnet/tools/patcher.py data/test 1024 1024 320 
      data/patches-1024-ol-320-m01/test 
      -csv data/groundtruth/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv 
      && python oficial_herdnet/tools/csv_to_points.py 
      -i data/patches-1024-ol-320-m01/test/gt.csv 
      -o data/patches-1024-ol-320-m01/test_points_gt.csv
    deps:
      - data/groundtruth/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv
      - data/test/
      - oficial_herdnet/tools/patcher.py
    outs:
      - data/patches-1024-ol-320-m01/test_points_gt.csv
      - data/patches-1024-ol-320-m01/test/

  train-herdnet-v0:
    cmd: python oficial_herdnet/tools/train.py 
      train.wandb_run="'Herdnet Train 0'"
      train.training_settings.work_dir=data/models/herdnet_v0/
      train.training_settings.epochs=25
    deps:
      - data/patches-512-ol-160-m01/train_points_gt.csv
      - data/patches-512-ol-160-m01/train/
      - data/patches-512-ol-160-m01/val_points_gt.csv
      - data/patches-512-ol-160-m01/val/
    outs:
      - data/models/herdnet_v0/

  train-herdnet-v1:
    cmd: python oficial_herdnet/tools/train.py 
      train.training_settings.work_dir=data/models/herdnet_v1/
    deps:
      - data/patches-512-ol-160-m01/train_points_gt.csv
      - data/patches-512-ol-160-m01/train/
      - data/patches-512-ol-160-m01/val_points_gt.csv
      - data/patches-512-ol-160-m01/val/
    outs:
      - data/models/herdnet_v1/

  train-herdnet-v2:
    desc: Set weights for unbalanced classes
    cmd: python oficial_herdnet/tools/train.py 
      train.wandb_run="'Herdnet Train 2 cross ent weights'"
      train.losses.CrossEntropyLoss.kwargs.weight=[0.1,1.2,1.9,1.16,6.37,12.12,1.0]
      train.training_settings.work_dir=data/models/herdnet_v2/
    deps:
      - data/patches-512-ol-160-m01/train_points_gt.csv
      - data/patches-512-ol-160-m01/train/
      - data/patches-512-ol-160-m01/val_points_gt.csv
      - data/patches-512-ol-160-m01/val/
    outs:
      - data/models/herdnet_v2/
  
  train-herdnet-v3:
    desc: Train with 1024x1024 images
    cmd: python oficial_herdnet/tools/train.py 
      train.wandb_run="'Herdnet Train 3 1024x1024'"
      train.wandb_mode='online'
      train.datasets.img_size=[1024,1024]
      train.losses.CrossEntropyLoss.kwargs.weight=[0.1,1.2,1.9,1.16,6.37,12.12,1.0]
      train.datasets.train.csv_file=data/patches-1024-ol-320-m01/train_points_gt.csv
      train.datasets.train.root_dir=data/patches-1024-ol-320-m01/train/
      train.datasets.validate.csv_file=data/patches-1024-ol-320-m01/val_points_gt.csv
      train.datasets.validate.root_dir=data/patches-1024-ol-320-m01/val/
      train.training_settings.work_dir=data/models/herdnet_v3/
      train.training_settings.batch_size=2
      train.training_settings.stitcher=null
    deps:
      - data/patches-1024-ol-320-m01/train_points_gt.csv
      - data/patches-1024-ol-320-m01/train/
      - data/patches-1024-ol-320-m01/val_points_gt.csv
      - data/patches-1024-ol-320-m01/val/
    outs:
      - data/models/herdnet_v3/

  train-herdnet-v4:
    desc: From v2 change model head_conv to 128
    cmd: python oficial_herdnet/tools/train.py
      train.wandb_run="'Herdnet Train 4 head_conv 128'"
      train.wandb_mode='online'
      train.model.kwargs.head_conv=128
      train.losses.CrossEntropyLoss.kwargs.weight=[0.1,1.2,1.9,1.16,6.37,12.12,1.0]
      train.training_settings.work_dir=data/models/herdnet_v4/
      train.training_settings.stitcher=null
    deps:
      - data/patches-512-ol-160-m01/train_points_gt.csv
      - data/patches-512-ol-160-m01/train/
      - data/patches-512-ol-160-m01/val_points_gt.csv
      - data/patches-512-ol-160-m01/val/
    outs:
      - data/models/herdnet_v4/

  desc-herdnet-v1:
    desc: >
      Generate report of number of params per layer of herdnet-v1
      # trainable_backbone_layers=5 for this report (to report all layers)
      # but we trained with just 4 backbone layers
    cmd: >
      python tools/describe_model.py --config-path=$PWD/configs
      test=herdnet
      test.device_name="cpu"
      test.model.pth_file=data/models/herdnet_v1/best_model.pth
      +test.group_depth=2
      +test.results_file=data/model_descs/parameters-herdnet-v1.csv
    deps:
      - tools/describe_model.py
      - oficial_herdnet/configs/test/herdnet.yaml
      - data/models/herdnet_v1/best_model.pth
    outs:
      - data/model_descs/parameters-herdnet-v1.csv

  test-herdnet-v0: # sobre patches!
    # test.sticher=null because we are running over patches of size 512x512
    cmd: >
      python oficial_herdnet/tools/test.py --config-path ../configs/ --config-name="config"
      test.wandb_run="'Test herdnet v0'"
      test.wandb_mode=online
      test.model.pth_file=data/models/herdnet_v0/best_model.pth
      test.dataset.csv_file=data/patches-512-ol-160-m01/test_points_gt.csv
      test.dataset.root_dir=data/patches-512-ol-160-m01/test/
      test.stitcher=null
      test.results_dir=data/test_results/herdnet_v0/
    deps:
      - oficial_herdnet/configs/test/herdnet.yaml
      - data/patches-512-ol-160-m01/test_points_gt.csv
      - data/patches-512-ol-160-m01/test/
    outs:
      - data/test_results/herdnet_v0/

  test-herdnet-v1: # sobre patches
    # test.sticher=null because we are running over patches of size 512x512
    cmd: >
      python oficial_herdnet/tools/test.py --config-path ../configs/ --config-name="config"
      test.wandb_run='Test-2-herdnet_v1-100-epochs'
      test.wandb_mode=online
      test.model.pth_file=data/models/herdnet_v1/best_model.pth
      test.dataset.csv_file=data/patches-512-ol-160-m01/test_points_gt.csv
      test.dataset.root_dir=data/patches-512-ol-160-m01/test/
      test.stitcher=null
      test.results_dir=data/test_results/herdnet_v1/
    deps:
      - oficial_herdnet/configs/test/herdnet.yaml
      - data/patches-512-ol-160-m01/test_points_gt.csv
      - data/patches-512-ol-160-m01/test/
      - data/models/herdnet_v1/best_model.pth
    outs:
      - data/test_results/herdnet_v1/

  test-herdnet-v2: # sobre patches
    # test.sticher=null because we are running over patches of size 512x512
    cmd: >
      python oficial_herdnet/tools/test.py --config-path ../configs/ --config-name="config"
      test.wandb_run="'Test herdnet v2 cross ent weights'"
      test.wandb_mode=online
      test.model.pth_file=data/models/herdnet_v2/best_model.pth
      test.dataset.csv_file=data/patches-512-ol-160-m01/test_points_gt.csv
      test.dataset.root_dir=data/patches-512-ol-160-m01/test/
      test.stitcher=null
      test.results_dir=data/test_results/herdnet_v2/
    deps:
      - oficial_herdnet/configs/test/herdnet.yaml
      - data/patches-512-ol-160-m01/test_points_gt.csv
      - data/patches-512-ol-160-m01/test/
      - data/models/herdnet_v2/best_model.pth
    outs:
      - data/test_results/herdnet_v2/

  test-herdnet-v2-full-imgs: # sobre imágenes full
    cmd: >
      python oficial_herdnet/tools/test.py --config-path ../configs/ --config-name="config"
      test.wandb_run="'Test herdnet v2 full images'"
      test.wandb_mode=online
      test.model.pth_file=data/models/herdnet_v2/best_model.pth
      test.dataset.csv_file=data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv
      test.dataset.root_dir=data/test/      
      test.results_dir=data/test_results/herdnet_v2_full_imgs/
    deps:
      - oficial_herdnet/configs/test/herdnet.yaml
      - data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv
      - data/test/

    outs:
      - data/test_results/herdnet_v2_full_imgs/

  test-herdnet-v2-hn:
    # Nota: a diferencia de test-herdnet-v2 y test-herdnet-v1, este test usa imágenes full-size
    # usamos el stitcher del config
    cmd: >
      python oficial_herdnet/tools/test.py --config-path ../configs/ --config-name="config"
      test.wandb_run="'Test herdnet v2-hn'"
      test.wandb_mode=online
      test.model.pth_file=data/models/herdnet_v2_hn/best_model.pth
      test.dataset.csv_file=data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv
      test.dataset.root_dir=data/test/      
      test.results_dir=data/test_results/herdnet_v2_hn/
    deps:
      - oficial_herdnet/configs/test/herdnet.yaml
      - data/patches-512-ol-160-m01/test_points_gt.csv
      - data/patches-512-ol-160-m01/test/
      - data/models/herdnet_v2_hn/best_model.pth
    outs:
      - data/test_results/herdnet_v2_hn/

  test-herdnet-v3-full-imgs:
    cmd: >
      python oficial_herdnet/tools/test.py --config-path ../configs/ --config-name="config"
      test.wandb_run="'Test herdnet v3 patches 1024'"
      test.wandb_mode=online
      test.model.pth_file=data/models/herdnet_v3/best_model.pth
      test.dataset.img_size=[1024,1024]
      test.dataset.csv_file=data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv
      test.dataset.root_dir=data/test/
      test.results_dir=data/test_results/herdnet_v3_full_imgs/
    deps:
      - oficial_herdnet/configs/test/herdnet.yaml
      - data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv
      - data/test/
    outs:
      - data/test_results/herdnet_v3_full_imgs/

  test-herdnet-v4-full-imgs:
    cmd: >
      python oficial_herdnet/tools/test.py --config-path ../configs/ --config-name="config"
      test.wandb_run="Test herdnet v4"
      test.wandb_mode=online      
      test.model.pth_file=data/models/herdnet_v4/best_model.pth
      test.model.kwargs.head_conv=128
      test.dataset.csv_file=data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv
      test.dataset.root_dir=data/test/
      test.results_dir=data/test_results/herdnet_v4_full_imgs/
    deps:
      - oficial_herdnet/configs/test/herdnet.yaml
      - data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv
      - data/test/
    outs:
      - data/test_results/herdnet_v4_full_imgs/

  infer-train-herdnet-v2:
    desc: >
      First step for HNM, infer over full size images.
    cmd: python animaloc_improved/tools/infer_v2.py
      data/train/
      data/models/herdnet_v2/best_model.pth
      -dest data/inference/herdnet_v2/train
    deps:
      - animaloc_improved/tools/infer_v2.py
      - data/models/herdnet_v2/best_model.pth
      - data/train
    outs:
      - data/inference/herdnet_v2/train

  infer-valid-herdnet-v2:
    desc: >
      First step for HNM, infer over full size images.
    cmd: python animaloc_improved/tools/infer_v2.py
      data/val/
      data/models/herdnet_v2/best_model.pth
      -dest data/inference/herdnet_v2/val
    deps:
      - animaloc_improved/tools/infer_v2.py
      - data/models/herdnet_v2/best_model.pth
      - data/val
    outs:
      - data/inference/herdnet_v2/val

  mine-hard-negs-herdnet-v2:
    desc: Mine hard negs for train and val
    cmd: >
      python animaloc_improved/tools/mine_hard_negs.py from-pt-dets
      --gt_boxes data/groundtruth/csv/train_big_size_A_B_E_K_WH_WB-fixed-header.csv
      --pt_dets  data/inference/herdnet_v2/train/detections.csv
      --out      data/gt-preprocessed/csv/train_gt_boxes_and_hard_negs.csv
      &&
      python animaloc_improved/tools/mine_hard_negs.py from-pt-dets
      --gt_boxes data/groundtruth/csv/val_big_size_A_B_E_K_WH_WB-fixed-header.csv
      --pt_dets  data/inference/herdnet_v2/val/detections.csv
      --out      data/gt-preprocessed/csv/val_gt_boxes_and_hard_negs.csv
    deps:
      - animaloc_improved/tools/mine_hard_negs.py
      - data/groundtruth/csv/train_big_size_A_B_E_K_WH_WB-fixed-header.csv
      - data/inference/herdnet_v2/train/detections.csv
      - data/groundtruth/csv/val_big_size_A_B_E_K_WH_WB-fixed-header.csv
      - data/inference/herdnet_v2/val/detections.csv
    outs:
      - data/gt-preprocessed/csv/train_gt_boxes_and_hard_negs.csv
      - data/gt-preprocessed/csv/val_gt_boxes_and_hard_negs.csv

  patches-512-ol-160-mv01-with-hard-negs-train:
    cmd: python oficial_herdnet/tools/patcher.py data/train 512 512 160
      data/patches-512-ol-160-m01-w-hard-negs/train
      -csv data/gt-preprocessed/csv/train_gt_boxes_and_hard_negs.csv
      &&
      cp data/patches-512-ol-160-m01-w-hard-negs/train/gt.csv
      data/patches-512-ol-160-m01-w-hard-negs/train_points_gt.csv
    deps:
      - oficial_herdnet/tools/patcher.py
      - data/train/
      - data/gt-preprocessed/csv/train_gt_boxes_and_hard_negs.csv
    outs:
      - data/patches-512-ol-160-m01-w-hard-negs/train_points_gt.csv
      - data/patches-512-ol-160-m01-w-hard-negs/train/

  patches-512-ol-160-mv01-with-hard-negs-val:
    cmd: python oficial_herdnet/tools/patcher.py data/val 512 512 160
      data/patches-512-ol-160-m01-w-hard-negs/val
      -csv data/gt-preprocessed/csv/val_gt_boxes_and_hard_negs.csv
      &&
      cp data/patches-512-ol-160-m01-w-hard-negs/val/gt.csv
      data/patches-512-ol-160-m01-w-hard-negs/val_points_gt.csv
    deps:
      - oficial_herdnet/tools/patcher.py
      - data/val/
      - data/gt-preprocessed/csv/val_gt_boxes_and_hard_negs.csv
    outs:
      - data/patches-512-ol-160-m01-w-hard-negs/val_points_gt.csv
      - data/patches-512-ol-160-m01-w-hard-negs/val/

  train-herdnet-v2-hn:
    desc: Keep training herdnet v2 but now with hard negatives
    # Validación incluyendo HNs genera error...
    # train.datasets.validate.csv_file=data/patches-512-ol-160-m01-w-hard-negs/val_points_gt.csv
    # train.datasets.validate.root_dir=data/patches-512-ol-160-m01-w-hard-negs/val
    cmd: python oficial_herdnet/tools/train.py
      train.wandb_run="'Herdnet v2-Hard Negs'"
      train.wandb_mode=offline
      train.model.load_from=data/models/herdnet_v2/best_model.pth
      train.training_settings.epochs=50
      train.datasets.train.csv_file=data/patches-512-ol-160-m01-w-hard-negs/train_points_gt.csv
      train.datasets.train.root_dir=data/patches-512-ol-160-m01-w-hard-negs/train
      train.datasets.validate.csv_file=data/patches-512-ol-160-m01/val_points_gt.csv
      train.datasets.validate.root_dir=data/patches-512-ol-160-m01/val      
      train.losses.CrossEntropyLoss.kwargs.weight=[0.1,1.2,1.9,1.16,6.37,12.12,1.0]
      train.training_settings.work_dir=data/models/herdnet_v2_hn/
    deps:
      - data/patches-512-ol-160-m01-w-hard-negs/train_points_gt.csv
      - data/patches-512-ol-160-m01-w-hard-negs/train
      - data/patches-512-ol-160-m01/val_points_gt.csv
      - data/patches-512-ol-160-m01/val/
    outs:
      - data/models/herdnet_v2_hn/

  train-herdnet-v2-hn2:
    desc: Keep training herdnet v2 but now with hard negatives - part 2, 100 more epochs
    # Validación incluyendo HNs genera error...
    # train.datasets.validate.csv_file=data/patches-512-ol-160-m01-w-hard-negs/val_points_gt.csv
    # train.datasets.validate.root_dir=data/patches-512-ol-160-m01-w-hard-negs/val
    cmd: python oficial_herdnet/tools/train.py
      train.wandb_run="'Herdnet v2-Hard Negs-part2'"
      train.wandb_mode=offline
      train.model.load_from=data/models/herdnet_v2_hn/best_model.pth
      train.training_settings.epochs=100
      train.datasets.train.csv_file=data/patches-512-ol-160-m01-w-hard-negs/train_points_gt.csv
      train.datasets.train.root_dir=data/patches-512-ol-160-m01-w-hard-negs/train
      train.datasets.validate.csv_file=data/patches-512-ol-160-m01/val_points_gt.csv
      train.datasets.validate.root_dir=data/patches-512-ol-160-m01/val
      train.losses.CrossEntropyLoss.kwargs.weight=[0.1,1.2,1.9,1.16,6.37,12.12,1.0]
      train.training_settings.work_dir=data/models/herdnet_v2_hn2/
    deps:
      - data/models/herdnet_v2_hn/best_model.pth
      - data/patches-512-ol-160-m01-w-hard-negs/train_points_gt.csv
      - data/patches-512-ol-160-m01-w-hard-negs/train
      - data/patches-512-ol-160-m01/val_points_gt.csv
      - data/patches-512-ol-160-m01/val/
    outs:
      - data/models/herdnet_v2_hn2/

  test-full-to-points:
    cmd: python oficial_herdnet/tools/csv_to_points.py
      -i data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv
      -o data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv
    deps:
      - oficial_herdnet/tools/csv_to_points.py
      - data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv
    outs:
      - data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv

  test-herdnet-v1-fullimgs: # sobre imágenes full
    cmd: >
      python oficial_herdnet/tools/test.py --config-path $PWD/oficial_herdnet/configs/
      test=herdnet
      test.wandb_run='test-herdnet_v1-full-imgs'
      test.wandb_mode=offline
      test.model.pth_file=data/models/herdnet_v1/best_model.pth
      test.dataset.csv_file=data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv
      test.dataset.root_dir=data/test/
      test.results_dir=data/test_results/herdnet_v1_fullimgs/
    deps:
      - oficial_herdnet/configs/test/herdnet.yaml
      - data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-points.csv
      - data/test/
    outs:
      - data/test_results/herdnet_v1_fullimgs/

  fix-headers-train-csv:
    cmd: >
      sed '1s/Image,x1,y1,x2,y2,Label/images,x_min,y_min,x_max,y_max,labels/'
      data/groundtruth/csv/train_big_size_A_B_E_K_WH_WB.csv
      > data/gt-preprocessed/csv/train_big_size_A_B_E_K_WH_WB-fixed-header.csv
    deps:
      - data/groundtruth/csv/train_big_size_A_B_E_K_WH_WB.csv
    outs:
      - data/gt-preprocessed/csv/train_big_size_A_B_E_K_WH_WB-fixed-header.csv

  fix-headers-val-csv:
    cmd: >
      sed '1s/Image,x1,y1,x2,y2,Label/images,x_min,y_min,x_max,y_max,labels/'
      data/groundtruth/csv/val_big_size_A_B_E_K_WH_WB.csv
      > data/gt-preprocessed/csv/val_big_size_A_B_E_K_WH_WB-fixed-header.csv
    deps:
      - data/groundtruth/csv/val_big_size_A_B_E_K_WH_WB.csv
    outs:
      - data/gt-preprocessed/csv/val_big_size_A_B_E_K_WH_WB-fixed-header.csv

  fix-headers-test-csv:
    cmd: >
      sed '1s/Image,x1,y1,x2,y2,Label/images,x_min,y_min,x_max,y_max,labels/'
      data/groundtruth/csv/test_big_size_A_B_E_K_WH_WB.csv
      > data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv
    deps:
      - data/groundtruth/csv/test_big_size_A_B_E_K_WH_WB.csv
    outs:
      - data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv

  patches-512-ol-160-mv0.3-train:
    cmd: >
      python oficial_herdnet/tools/patcher.py
      -csv data/gt-preprocessed/csv/train_big_size_A_B_E_K_WH_WB-fixed-header.csv
      -min 0.3
      data/train/
      512 512 160
      data/patches-512-ol-160-m0.3/train
    deps:
      - oficial_herdnet/tools/patcher.py
      - data/train/
      - data/gt-preprocessed/csv/train_big_size_A_B_E_K_WH_WB-fixed-header.csv
    outs:
      - data/patches-512-ol-160-m0.3/train

  patches-512-ol-160-mv0.3-val:
    cmd: >
      python oficial_herdnet/tools/patcher.py
      -csv data/gt-preprocessed/csv/val_big_size_A_B_E_K_WH_WB-fixed-header.csv
      -min 0.3
      data/val/
      512 512 160
      data/patches-512-ol-160-m0.3/val
    deps:
      - oficial_herdnet/tools/patcher.py
      - data/val/
      - data/gt-preprocessed/csv/val_big_size_A_B_E_K_WH_WB-fixed-header.csv
    outs:
      - data/patches-512-ol-160-m0.3/val

  patches-512-ol-160-mv0.3-test:
    cmd: >
      python oficial_herdnet/tools/patcher.py
      -csv data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv
      -min 0.3
      data/test/
      512 512 160
      data/patches-512-ol-160-m0.3/test
    deps:
      - oficial_herdnet/tools/patcher.py
      - data/test/
      - data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv
    outs:
      - data/patches-512-ol-160-m0.3/test/

  patches-512-ol-160-mv0.3-train-tiny:
    desc: Seleccionar un subconjunto diminuto del conjunto de parches de entrenamiento para hacer tests rápidos
      del flujo de train.
    cmd: >
      mkdir -p data/patches-512-ol-160-m0.3/train-tiny && head -n 200 data/patches-512-ol-160-m0.3/train/gt.csv
      > data/patches-512-ol-160-m0.3/train-tiny/gt-head-200.csv
    deps:
      - data/patches-512-ol-160-m0.3/train/gt.csv
    outs:
      - data/patches-512-ol-160-m0.3/train-tiny/gt-head-200.csv

  patches-512-ol-160-mv0.3-valid-tiny:
    desc: Seleccionar un subconjunto diminuto del conjunto de parches de validación para hacer tests rápidos
      del flujo de train.
    cmd: >
      mkdir -p data/patches-512-ol-160-m0.3/val-tiny &&
      head -n 25 data/patches-512-ol-160-m0.3/val/gt.csv
      > data/patches-512-ol-160-m0.3/val-tiny/gt-head-25.csv
    deps:
      - data/patches-512-ol-160-m0.3/val/gt.csv
    outs:
      - data/patches-512-ol-160-m0.3/val-tiny/gt-head-25.csv

  train-faster-rcnn-hn-trainer:
    desc: Entrenar faster-rcnn via trainer from Herdnet/tools/train.py
    cmd: >
       python oficial_herdnet/tools/train.py  --config-path $PWD/configs/
       train=faster_rcnn_herdnet_trainer
       train.wandb_mode=offline
       train.wandb_run=faster-rcnn-resnet-50
       train.model.kwargs.architecture=resnet50
       train.training_settings.work_dir=data/models/faster-rcnn/resnet50-100-epochs-tbl4
       train.training_settings.lr=0.0001
       train.training_settings.epochs=100
    deps:
      - configs/train/faster_rcnn_herdnet_trainer.yaml
      - oficial_herdnet/tools/train.py
      - data/patches-512-ol-160-m01/train/gt.csv
    outs:
      - data/models/faster-rcnn/resnet50-100-epochs-tbl4

  train-faster-rcnn-resnet-101:
    desc: Entrenar faster-rcnn via trainer end Herdnet/tools/train.py
    cmd: >
      python oficial_herdnet/tools/train.py  --config-path $PWD/configs/
      train=faster_rcnn_herdnet_trainer
      train.wandb_mode=offline
      train.wandb_run=faster-rcnn-resnet-101
      train.model.kwargs.architecture=resnet101
      train.training_settings.work_dir=data/models/faster-rcnn/resnet101-100-epochs-tbl4
      train.training_settings.lr=0.0001
      train.training_settings.epochs=100
    deps:
      - configs/train/faster_rcnn_herdnet_trainer.yaml
      - oficial_herdnet/tools/train.py
      - data/patches-512-ol-160-m01/train/gt.csv
    outs:
      - data/models/faster-rcnn/resnet101-100-epochs-tbl4

  test-faster-rcnn-resnet101-full:
    desc: >
      Ejecutar el script de test sobre el modelo faster-rcnn-resnet101 sobre imágenes full.
    # Como las imágenes tienen tamaños diversos hay que poner test.datasetbatch_size=1
    cmd: >
      python oficial_herdnet/tools/test.py  --config-path $PWD/configs/
      test=faster_rcnn
      test.device_name="cuda"
      test.wandb_mode="online"
      test.dataset.batch_size=1
      test.wandb_run=test-frcnn-resnet101
      test.model.pth_file=data/models/faster-rcnn/resnet101-100-epochs-tbl4/best_model.pth
      test.model.kwargs.architecture=resnet101
      test.dataset.csv_file=data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv
      test.dataset.root_dir=data/test/
      test.results_dir=data/test_results/frcnn-resnet101-full-imgs
    deps:
      - ./configs/test/faster_rcnn.yaml
      - data/models/faster-rcnn/resnet101-100-epochs-tbl4
      - data/test/
    outs:
      - data/test_results/frcnn-resnet101-full-imgs

  train-faster-rcnn-hn-trainer-tiny:
    desc: >
      Entrenar faster-rcnn via trainer from Herdnet/tools/train.py con datasets mucho mas pequeños para probar
      todo el flujo rápido
    cmd: >
       python oficial_herdnet/tools/train.py  --config-path $PWD/configs/
       train=faster_rcnn_herdnet_trainer
       train.training_settings.work_dir=data/models/faster-rcnn-tiny
       train.training_settings.epochs=3
       train.datasets.train.csv_file=data/patches-512-ol-160-m0.3/train-tiny/gt-head-200.csv
       train.datasets.validate.csv_file=data/patches-512-ol-160-m0.3/val-tiny/gt-head-25.csv
       train.training_settings.print_freq=10
    deps:
      - oficial_herdnet/tools/train.py
      - data/patches-512-ol-160-m0.3/train-tiny/gt-head-200.csv
      - data/patches-512-ol-160-m0.3/val-tiny/gt-head-25.csv
    outs:
      - data/models/faster-rcnn-tiny

  add-info-to-tmp-model:
    desc: >
      Add metadata and transforms to a model that comes from an intermediate epoch.
    cmd: >
      python animaloc_improved/tools/add_info_to_model.py --config-path $PWD/configs/
      train=faster_rcnn_herdnet_trainer
      add_info.best_model_pth_path=data/models/tmp/faster-rcnn/best_model-by-epoch-70.pth

  test-faster-rcnn-resnet50:
    desc: >
      Ejecutar el script de test sobre el modelo faster-rcnn-resnet50 sobre patches
    # test.sticher=null because we are running over patches of size 512x512
    cmd: >
      python oficial_herdnet/tools/test.py  --config-path $PWD/configs/
      test=faster_rcnn
      test.device_name="cuda"
      test.wandb_mode="online"
      test.wandb_run=test-frcnn-resnet50
      test.model.pth_file=data/models/faster-rcnn/resnet50-100-epochs-tbl4/best_model.pth
      test.model.kwargs.architecture=resnet50
      test.stitcher=null
      test.dataset.csv_file=data/patches-512-ol-160-m0.3/test/gt.csv
      test.dataset.root_dir=data/patches-512-ol-160-m0.3/test/
      test.results_dir=data/test_results/frcnn-resnet50
    deps:
      - ./configs/test/faster_rcnn.yaml
      - data/models/faster-rcnn/resnet50-100-epochs-tbl4
      - data/patches-512-ol-160-m0.3/test/
    outs:
      - data/test_results/frcnn-resnet50

  desc-faster-rcnn-resnet50:
    desc: >
      Generate report of number of params per layer
      # trainable_backbone_layers=5 for this report (to report all layers)
      # but we trained with just 4 backbone layers
    cmd: >
      python animaloc_improved/tools/describe_model.py --config-path=$PWD/configs
      test=faster_rcnn
      test.device_name="cpu"
      test.model.kwargs.architecture=resnet50
      test.model.kwargs.trainable_backbone_layers=4
      test.model.pth_file=data/models/faster-rcnn/resnet50-100-epochs-tbl4/best_model.pth
      +test.group_depth=2
      +test.results_file=data/model_descs/parameters-frcnn-resnet-50.csv

    deps:
      - animaloc_improved/tools/describe_model.py
      - ./configs/test/faster_rcnn.yaml
      - data/models/faster-rcnn/resnet50-100-epochs-tbl4
    outs:
      - data/model_descs/parameters-frcnn-resnet-50.csv

  desc-faster-rcnn-resnet101:
    desc: >
      Generate report of number of params per layer of faster-rcnn-resnet-101
      # trainable_backbone_layers=5 for this report (to report all layers)
      # but we trained with just 4 backbone layers
    cmd: >
      python animaloc_improved/tools/describe_model.py --config-path=$PWD/configs
      test=faster_rcnn
      test.device_name="cpu"
      test.model.kwargs.architecture=resnet101
      test.model.kwargs.trainable_backbone_layers=4
      test.model.pth_file=data/models/faster-rcnn/resnet101-100-epochs-tbl4/best_model.pth
      +test.group_depth=2
      +test.results_file=data/model_descs/parameters-frcnn-resnet-101.csv

    deps:
      - animaloc_improved/tools/describe_model.py
      - ./configs/test/faster_rcnn.yaml
      - data/models/faster-rcnn/resnet101-100-epochs-tbl4
    outs:
      - data/model_descs/parameters-frcnn-resnet-101.csv

  test-faster-rcnn-resnet50-full:
    desc: >
      Ejecutar el script de test sobre el modelo faster-rcnn-resnet50 sobre imágenes full.
    # Como las imágenes tienen tamaños diversos hay que poner test.datasetbatch_size=1
    cmd: >
      python oficial_herdnet/tools/test.py  --config-path $PWD/configs/
      test=faster_rcnn
      test.device_name="cuda"
      test.wandb_mode="online"
      test.dataset.batch_size=1
      test.wandb_run=test-frcnn-resnet50
      test.model.pth_file=data/models/faster-rcnn/resnet50-100-epochs-tbl4/best_model.pth
      test.model.kwargs.architecture=resnet50
      test.dataset.csv_file=data/gt-preprocessed/csv/test_big_size_A_B_E_K_WH_WB-fixed-header.csv
      test.dataset.root_dir=data/test/
      test.results_dir=data/test_results/frcnn-resnet50-full-imgs
    deps:
      - ./configs/test/faster_rcnn.yaml
      - data/models/faster-rcnn/resnet50-100-epochs-tbl4
      - data/test/
    outs:
      - data/test_results/frcnn-resnet50-full-imgs

  faster-rcnn-resnet50-full-to-excel:
    desc: >
      Transform confusion matrix and matrix to xlsx format
    cmd: >
      python animaloc_improved/tools/results_to_excel.py
      data/test_results/frcnn-resnet50-full-imgs
      -o data/test_results/frcnn-resnet50-full-imgs-xlsx
    deps:
      - data/test_results/frcnn-resnet50-full-imgs
    outs:
      - data/test_results/frcnn-resnet50-full-imgs-xlsx

  faster-rcnn-resnet101-full-to-excel:
    desc: >
      Transform confusion matrix and matrix to xlsx format
    cmd: >
      python animaloc_improved/tools/results_to_excel.py
      data/test_results/frcnn-resnet101-full-imgs
      -o data/test_results/frcnn-resnet101-full-imgs-xlsx
    deps:
      - data/test_results/frcnn-resnet101-full-imgs
    outs:
      - data/test_results/frcnn-resnet101-full-imgs-xlsx
